<html>
<head>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io('http://0.0.0.0:1337');

  var layers, sources, grid;

  $(function(){
  	$('button#create-layer').click(create_layer);
  	$("select#sources").change(refresh_source_options);
    $('li.layer button.destroy-layer').live(destroy_layer);
  });

  var html = new Object();

  html.layer = function(){
  	return '<li id="'+this.id+'" class="layer"><h1>Layer '+this.id+' ('+this.name+') using '+this.source.name+' (Active: '+this.source.active+')</h1><button class="destroy-layer" data-id="'+this.id+'">Delete</button></li>';
  }
  html.source = function(key){
  	return '<option id="'+key+'" class="source" value="'+this.name+'">'+this.name+'</option>';
  }

  html.source_option = function(key){
  	return '<li id="'+key+'" class="source-option"><label for="'+this.name+'">'+this.name+'</label><input type="text" id="'+this.name+'" name="'+this.name+'" value="'+this.default+'" /></li>';
  }

  function create_layer(event){ 
  	event.preventDefault();
  	var formdata = $('form#source-options').serializeObject();
  	// var source_options = JSON.stringify(formdata);
  	// console.log(formdata)
  	socket.emit('create layer', $('input#layer-name').val(), $('select#sources option:selected').val(), formdata);
  }

  function create_layer_success(layer_object){
    console.log('Layer successfully added.');
    console.dir(layer_object);
    socket.emit('list layers');
  }

  function destroy_layer(){
    var layer_id = $(this).attr('data-id');
    console.log('delete layer '+layer_id);
    socket.emit('destroy layer', layer_id);
  }

  function refresh_layers(layers_array){ 
  	layers = layers_array;
    $('section#layers ul').empty();
  	$.each(layers_array, function(key, value){
      console.log(html.layer.apply(value, [key]) );
  		$('section#layers ul').append( html.layer.apply(value)
      $('section#layers ul').find('li#'+key+' button.destroy-layer').bind('click', destroy_layer);
  	});
    console.log('Layers Refreshed');
    console.dir(layers_array);
  }

  function refresh_sources( sources_array ){ 
  	sources = sources_array;
  	$.each(sources, function(key, value){
  		$('select#sources').append(html.source.apply(value, [key]));
  	});
  }

  function refresh_source_options(){ 
    $('form#source-options ul').empty();

  	var index = $('select#sources option:selected').attr('id');
  	$.each(sources[index].options, function(key, value){
  		$('form#source-options ul').append( html.source_option.apply(this, [key] ))
  	});
  }

  // function refresh_mixer(){
  //   console.log('Mixer updated.');
  //   socket.emit('list layers');
  //   socket.emit('list sources');
  // }

  function error_log(error){
    console.log(error);
  }

  socket.emit('list layers');
  socket.on('refresh layers', refresh_layers);

  socket.emit('list sources');
  socket.on('refresh sources', refresh_sources);

  // socket.on('mixer update', refresh_mixer);

  socket.on('layer created', create_layer_success);

  socket.on('error', error_log);

</script>
</head>
<body>
	<header></header>
	<nav>
		<ul>
			<li><a href="#" id="show-layers">Layers</a></li>
			<li><a href="#" id="show-sources">Sources</a></li>
			<li><a href="#" id="show-grid">Grid</a></li>
		</ul>
  </nav>
	<main>
		<form id="layer-create">
			<label for="layer-name">Layer Name</label><input id="layer-name" name="layer-name"  />
			<select id="sources"></select>
			<button id="create-layer">+ Layer</button>
		</form>
		<form id="source-options"><ul></ul></form>
		<section id="layers"><ul></ul></section>
		<section id="sources"><ul></ul></section>
		<section id="grid"><ul></ul></section>
	</main>
	<script>
	$.fn.serializeObject = function() {
		var o = {};
		var a = this.serializeArray();
		$.each(a, function() {
			if (o[this.name]) {
				if (!o[this.name].push) {
					o[this.name] = [o[this.name]];
				}
				o[this.name].push(this.value || '');
			} else {
				o[this.name] = this.value || '';
			}
		});
		return o;
	};
	</script>
	
</body>
</html>